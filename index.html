<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Poly Art 3D Funcional</title>
<style>
html, body { margin:0; height:100%; background: linear-gradient(180deg,#fff,#f3f4f6); overflow:hidden; font-family:sans-serif; }
#top-emojis { position:absolute; top:10px; left:0; right:0; text-align:center; font-size:28px; pointer-events:none; z-index:10; user-select:none; }
#three-container { width:100%; height:100%; }
.ui-bottom { position:absolute; bottom:0; width:100%; display:flex; overflow-x:auto; padding:10px; background:rgba(255,255,255,0.6); backdrop-filter:blur(6px); box-shadow:0 -2px 10px rgba(0,0,0,0.05); }
.thumb { width:72px; height:56px; margin-right:10px; border:2px solid transparent; border-radius:6px; overflow:hidden; cursor:pointer; flex:0 0 auto; box-shadow:0 4px 10px rgba(0,0,0,0.05); }
.thumb img { width:100%; height:100%; object-fit:cover; display:block; }
.thumb.active { border-color: rgba(96,165,250,0.85); }
@media(max-width:600px){ .thumb{width:60px; height:46px;} }
</style>
</head>
<body>
<div id="top-emojis">üß∏ ‚ù§Ô∏è üê•</div>
<div id="three-container"></div>
<div class="ui-bottom" id="ui-bottom"></div>

<script src="https://unpkg.com/three@0.154.0/build/three.min.js"></script>
<script>
(function(){
const IMAGES=['foto1.jpeg','foto2.jpeg','foto3.jpeg','foto4.jpeg'];
const container=document.getElementById('three-container');
const scene=new THREE.Scene();
const renderer=new THREE.WebGLRenderer({antialias:true, alpha:true});
renderer.setPixelRatio(window.devicePixelRatio);
container.appendChild(renderer.domElement);

const camera=new THREE.PerspectiveCamera(50,1,0.1,2000);
scene.add(new THREE.AmbientLight(0xffffff,0.9));
const dirLight=new THREE.DirectionalLight(0xffffff,0.2);
dirLight.position.set(1,1,1);
scene.add(dirLight);

let meshes=[],currentImageIndex=0;
let cols=10, rows=10;
let spherical={theta:0.5, phi:Math.PI/2-0.25, radius:400};
let sphericalTarget={...spherical};
const damping=0.12;
let isPointerDown=false, lastPointer={x:0,y:0};

function getPointer(e){ return e.touches?{x:e.touches[0].clientX,y:e.touches[0].clientY}:{x:e.clientX,y:e.clientY}; }
function onPointerDown(e){isPointerDown=true; lastPointer=getPointer(e);}
function onPointerMove(e){ if(!isPointerDown) return; const p=getPointer(e); const dx=p.x-lastPointer.x, dy=p.y-lastPointer.y; lastPointer=p; sphericalTarget.theta-=dx*0.006; sphericalTarget.phi-=dy*0.006; sphericalTarget.phi=Math.max(0.01, Math.min(Math.PI-0.99, sphericalTarget.phi)); }
function onPointerUp(){isPointerDown=false;}
function onWheel(e){e.preventDefault(); sphericalTarget.radius+=e.deltaY*0.6; sphericalTarget.radius=Math.max(120,Math.min(1200,sphericalTarget.radius));}

renderer.domElement.addEventListener('mousedown',onPointerDown);
window.addEventListener('mousemove',onPointerMove);
window.addEventListener('mouseup',onPointerUp);
renderer.domElement.addEventListener('touchstart',onPointerDown,{passive:true});
window.addEventListener('touchmove',onPointerMove,{passive:true});
window.addEventListener('touchend',onPointerUp);
renderer.domElement.addEventListener('wheel',onWheel,{passive:false});

function buildFromImage(img, c, r){
  meshes.forEach(m=>{scene.remove(m); if(m.geometry)m.geometry.dispose(); if(m.material)m.material.dispose();});
  meshes=[];

  const loader=new THREE.TextureLoader();
  loader.load(img.src, texture=>{
    texture.minFilter=THREE.LinearFilter;
    texture.magFilter=THREE.LinearFilter;

    const planeW=240;
    const planeH=planeW*(img.height/img.width);
    const startX=-planeW/2, startY=planeH/2;
    const cellW=planeW/c, cellH=planeH/r;

    for(let i=0;i<c;i++){
      for(let j=0;j<r;j++){
        const geom=new THREE.PlaneGeometry(cellW, cellH, 1,1);
        const uvAttr=geom.attributes.uv.array;
        // Ajustar UVs para fragmento exacto
        const u0=i/c, u1=(i+1)/c;
        const v0=j/r, v1=(j+1)/r;
        uvAttr[0]=u0; uvAttr[1]=1-v0;
        uvAttr[2]=u1; uvAttr[3]=1-v0;
        uvAttr[4]=u0; uvAttr[5]=1-v1;
        uvAttr[6]=u1; uvAttr[7]=1-v0;
        uvAttr[8]=u1; uvAttr[9]=1-v1;
        uvAttr[10]=u0; uvAttr[11]=1-v1;
        geom.attributes.uv.needsUpdate=true;

        const mat=new THREE.MeshBasicMaterial({map:texture, side:THREE.DoubleSide, transparent:true});
        const mesh=new THREE.Mesh(geom, mat);

        const tx=startX+(i+0.5)*cellW;
        const ty=startY-(j+0.5)*cellH;
        const tz=(Math.random()-0.5)*60;
        mesh.position.set(tx+(Math.random()-0.5)*60, ty+(Math.random()-0.5)*60, tz);
        meshes.push(mesh);
        scene.add(mesh);
      }
    }

    camera.position.set(0,0,Math.max(planeW,planeH)*1.5);
    camera.lookAt(0,0,0);
  });
}

function resize(){
  const w=container.clientWidth, h=container.clientHeight;
  renderer.setSize(w,h);
  camera.aspect=w/h;
  camera.updateProjectionMatrix();
}
window.addEventListener('resize',resize);

function updateCamera(){
  spherical.theta += (sphericalTarget.theta - spherical.theta)*damping;
  spherical.phi += (sphericalTarget.phi - spherical.phi)*damping;
  spherical.radius += (sphericalTarget.radius - spherical.radius)*damping;
  const r=spherical.radius;
  camera.position.set(r*Math.sin(spherical.phi)*Math.sin(spherical.theta),
                      r*Math.cos(spherical.phi),
                      r*Math.sin(spherical.phi)*Math.cos(spherical.theta));
  camera.lookAt(0,0,0);
}

function render(){
  requestAnimationFrame(render);
  updateCamera();
  renderer.render(scene,camera);
}

// Miniaturas
const uiBottom=document.getElementById('ui-bottom');
IMAGES.forEach((name,idx)=>{
  const div=document.createElement('div'); div.className='thumb'+(idx===0?' active':''); div.dataset.idx=idx;
  const img=document.createElement('img'); img.src=name; div.appendChild(img);
  div.addEventListener('click',()=>{
    document.querySelectorAll('.thumb').forEach(t=>t.classList.remove('active'));
    div.classList.add('active');
    loadImageAtIndex(idx);
  });
  uiBottom.appendChild(div);
});

function loadImageAtIndex(idx){
  currentImageIndex=idx;
  const img=new Image();
  img.onload=function(){ buildFromImage(img, cols, rows); };
  img.src=IMAGES[idx];
}

// Inicializar
resize();
loadImageAtIndex(0);
render();
})();
</script>
</body>
</html>
